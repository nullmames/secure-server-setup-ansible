---
#
# Prepare a target for an upgrade
# ansible-playbook main_cosmos_node_upgrade.yml -i inventory-testnet.ini --limit testnet_juno -e "upgrade_name=v12.0.0 node_version=1.2.3"
- name: Verify pre-requisites
  hosts: all
  gather_facts: false
  vars_files:
    - "{{ var_file }}"

  pre_tasks:
    - name: Verify upgrade_name is set
      ansible.builtin.fail:
        msg: upgrade_name is not set in config. Unable to continue.
      when: not upgrade_name

    - name: Verify version is set
      ansible.builtin.fail:
        msg: version is not set in config. Unable to continue.
      when: not node_version

    - name: Verify we're on the right node
      ansible.builtin.stat:
        path: "{{ user_dir }}/{{ folder }}"
      register: network_folder

    - name: Directory missing
      ansible.builtin.fail:
        msg: "Directory {{ folder }} does not exist. Wrong --limit?"
      when: not network_folder.stat.exists

- name: Prepare network upgrade using cosmovisor
  hosts: all
  gather_facts: true
  vars_files:
    - "{{ var_file }}"
  roles:
    - util_go_install
    - cosmos_node_install
    - cosmos_node_cosmovisor
    - cosmos_node_tools
    - cosmos_node_upgrade
